rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functionality
    // NOTE: These rules are loosely coupled with src/config/permissions.js and backend/rbac.py.
    // When updating roles, ensure these rules are also updated to reflect the new logic.
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner() {
      return isAuthenticated() && request.auth.token.role == 'owner';
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isManager() {
      return isAuthenticated() && request.auth.token.role == 'manager';
    }
    
    function isMember() {
      return isAuthenticated() && request.auth.token.role == 'member';
    }
    
    function hasFullAccess() {
      return isOwner() || isAdmin();
    }
    
    function hasTeamAccess(teamId) {
      return hasFullAccess() || request.auth.token.teamId == teamId;
    }
    
    // Organizations
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && request.auth.token.organizationId == orgId;
      allow write: if hasFullAccess();
    }
    
    // Teams
    match /teams/{teamId} {
      allow read: if isAuthenticated() && hasTeamAccess(teamId);
      allow write: if hasFullAccess();
    }
    
    // Users
    match /users/{userId} {
      allow get: if isAuthenticated() && request.auth.uid == userId;
      
      allow list: if isAuthenticated() && (
        hasFullAccess() || 
        ((isManager() || isMember()) && hasTeamAccess(resource.data.teamId))
      );
      
      allow write: if isAuthenticated() && (
        isOwner() || 
        // Admin: Can write users, but CANNOT touch Owner accounts
        (isAdmin() && (resource == null || resource.data.role != 'owner') && (request.resource == null || request.resource.data.role != 'owner')) ||
        // Managers can create/update users in their own team
        (isManager() && request.resource.data.teamId == request.auth.token.teamId) ||
        // Managers can delete users in their own team
        (isManager() && resource != null && resource.data.teamId == request.auth.token.teamId)
      );
      allow update: if request.auth.uid == userId;
    }
    
    // Claims
    match /claims/{claimId} {
      allow list: if isAuthenticated() && (
        hasFullAccess() ||
        isManager() ||
        isMember()
      );
      
      allow get: if isAuthenticated() && (
        hasFullAccess() ||
        ((isManager() || isMember()) && hasTeamAccess(resource.data.teamId))
      );
      
      allow create: if isAuthenticated() && 
        request.resource.data.submittedBy == request.auth.uid;
      
      allow update: if 
        hasFullAccess() ||
        // Manager: Any claim in their team
        (isManager() && hasTeamAccess(resource.data.teamId)) ||
        // Member: ONLY their own claim in their team
        (isMember() && hasTeamAccess(resource.data.teamId) && resource.data.submittedBy == request.auth.uid);
      
      allow delete: if 
        hasFullAccess() ||
        // Member: ONLY their own claim
        (isMember() && resource.data.submittedBy == request.auth.uid);
    }
    
    // Comments
    match /comments/{commentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
  }
}
